[CmtOrCodeOrString "module CommentRemoval ("]
[CmtOrCodeOrString "    HighLevelToken,"]
[CmtOrCodeOrString "    hltToString,"]
[CmtOrCodeOrString "    isOnlyIndentationLine,"]
[CmtOrCodeOrString "    rmCmtsWrapper,"]
[CmtOrCodeOrString "    lowLevelTokenizeWrapper,"]
[CmtOrCodeOrString "    highLevelTokenizeWrapper,"]
[CmtOrCodeOrString ") where"]
[CmtOrCodeOrString ""]
[CmtOrCodeOrString "import Control.Exception"]
[CmtOrCodeOrString "import Data.Char (isSpace)"]
[CmtOrCodeOrString "import Data.Maybe"]
[CmtOrCodeOrString "import Data.List"]
[CmtOrCodeOrString "import System.IO"]
[CmtOrCodeOrString ""]
[CmtOrCodeOrString "type Token       = String"]
[CmtOrCodeOrString "type CodeStr     = String"]
[CmtOrCodeOrString "type ShortCmtStr = String"]
[CmtOrCodeOrString "type LongCmtStr  = String"]
[CmtOrCodeOrString ""]
[LineCmtMark "--",CmtOrCodeOrString " A source file can be seen as a list of text lines. Each one"]
[LineCmtMark "--",CmtOrCodeOrString " being made of different items :"]
[LineCmtMark "--",CmtOrCodeOrString " source code, comments, comment delimiters, string constant, etc."]
[CmtOrCodeOrString "data LowLevelToken = CmtOrCodeOrString Token"]
[CmtOrCodeOrString "                   | CmtBegin          Token"]
[CmtOrCodeOrString "                   | CmtEnd            Token"]
[CmtOrCodeOrString "                   | LineCmtMark       Token"]
[CmtOrCodeOrString "                   | StringBeginOrEnd  Token"]
[CmtOrCodeOrString "                   | EscapedChar       Token"]
[CmtOrCodeOrString "                   deriving Show"]
[CmtOrCodeOrString ""]
[CmtOrCodeOrString "data HighLevelToken = Code     CodeStr"]
[CmtOrCodeOrString "                    | ShortCmt ShortCmtStr"]
[CmtOrCodeOrString "                    | LongCmt  LongCmtStr"]
[CmtOrCodeOrString "                    | StringInCode     CodeStr"]
[CmtOrCodeOrString "                    | StringInShortCmt ShortCmtStr"]
[CmtOrCodeOrString "                    | StringInLongCmt  LongCmtStr"]
[CmtOrCodeOrString "                    deriving Show"]
[CmtOrCodeOrString ""]
[CmtOrCodeOrString "data ParserState = ReadingCode"]
[CmtOrCodeOrString "                 | ReadingShortCmt"]
[CmtOrCodeOrString "                 | ReadingLongCmt"]
[CmtOrCodeOrString "                 | ReadingStringInCode"]
[CmtOrCodeOrString "                 | ReadingStringInShortCmt"]
[CmtOrCodeOrString "                 | ReadingStringInLongCmt"]
[CmtOrCodeOrString "                 | ReadingEscCharInStringInCode"]
[CmtOrCodeOrString "                 | ReadingEscCharInStringInShortCmt"]
[CmtOrCodeOrString "                 | ReadingEscCharInStringInLongCmt"]
[CmtOrCodeOrString "                 deriving Show"]
[CmtOrCodeOrString ""]
[CmtOrCodeOrString "lltToString :: LowLevelToken -> String"]
[CmtOrCodeOrString "lltToString (CmtOrCodeOrString s) = s"]
[CmtOrCodeOrString "lltToString (CmtBegin          s) = s"]
[CmtOrCodeOrString "lltToString (CmtEnd            s) = s"]
[CmtOrCodeOrString "lltToString (LineCmtMark       s) = s"]
[CmtOrCodeOrString "lltToString (StringBeginOrEnd  s) = s"]
[CmtOrCodeOrString "lltToString (EscapedChar       s) = s"]
[CmtOrCodeOrString ""]
[CmtOrCodeOrString "hltToString :: HighLevelToken -> String"]
[CmtOrCodeOrString "hltToString (Code             s) = s"]
[CmtOrCodeOrString "hltToString (ShortCmt         s) = s"]
[CmtOrCodeOrString "hltToString (LongCmt          s) = s"]
[CmtOrCodeOrString "hltToString (StringInCode     s) = s"]
[CmtOrCodeOrString "hltToString (StringInShortCmt s) = s"]
[CmtOrCodeOrString "hltToString (StringInLongCmt  s) = s"]
[CmtOrCodeOrString ""]
[CmtOrCodeOrString "isOnlyIndentationLine :: [HighLevelToken] -> Bool"]
[CmtOrCodeOrString "isOnlyIndentationLine [] = False"]
[CmtOrCodeOrString "isOnlyIndentationLine (x:[]) = isOnlyIndentation x"]
[CmtOrCodeOrString "    where"]
[CmtOrCodeOrString "      isOnlyIndentation (Code ",StringBeginOrEnd "\"",StringBeginOrEnd "\"",CmtOrCodeOrString ") = False"]
[CmtOrCodeOrString "      isOnlyIndentation (Code str) = all isSpace str"]
[CmtOrCodeOrString "      isOnlyIndentation _ = False"]
[CmtOrCodeOrString "isOnlyIndentationLine _ = False"]
[CmtOrCodeOrString ""]
[CmtOrCodeOrString "promote :: ParserState -> LowLevelToken -> HighLevelToken"]
[CmtOrCodeOrString "promote ReadingCode             (CmtOrCodeOrString x) = Code             x"]
[CmtOrCodeOrString "promote ReadingShortCmt         (CmtOrCodeOrString x) = ShortCmt         x"]
[CmtOrCodeOrString "promote ReadingLongCmt          (CmtOrCodeOrString x) = LongCmt          x"]
[CmtOrCodeOrString "promote ReadingStringInCode     (CmtOrCodeOrString x) = StringInCode     x"]
[CmtOrCodeOrString "promote ReadingStringInShortCmt (CmtOrCodeOrString x) = StringInShortCmt x"]
[CmtOrCodeOrString "promote ReadingStringInLongCmt  (CmtOrCodeOrString x) = StringInLongCmt  x"]
[CmtOrCodeOrString "promote ReadingCode             (StringBeginOrEnd  x) = StringInCode     x"]
[CmtOrCodeOrString "promote ReadingShortCmt         (StringBeginOrEnd  x) = StringInShortCmt x"]
[CmtOrCodeOrString "promote ReadingLongCmt          (StringBeginOrEnd  x) = StringInLongCmt  x"]
[CmtOrCodeOrString "promote ReadingStringInCode     (StringBeginOrEnd  x) = StringInCode     x"]
[CmtOrCodeOrString "promote ReadingStringInShortCmt (StringBeginOrEnd  x) = StringInShortCmt x"]
[CmtOrCodeOrString "promote ReadingStringInLongCmt  (StringBeginOrEnd  x) = StringInLongCmt  x"]
[CmtOrCodeOrString "promote ReadingStringInCode     (EscapedChar       x) = StringInCode     x"]
[CmtOrCodeOrString "promote ReadingStringInShortCmt (EscapedChar       x) = StringInShortCmt x"]
[CmtOrCodeOrString "promote ReadingStringInLongCmt  (EscapedChar       x) = StringInLongCmt  x"]
[CmtOrCodeOrString "promote ReadingCode             (EscapedChar       x) ="]
[CmtOrCodeOrString "    error (",StringBeginOrEnd "\"",CmtOrCodeOrString "while ReadingCode, got EscapedChar: ",StringBeginOrEnd "\"",CmtOrCodeOrString " ++ x)"]
[CmtOrCodeOrString "promote ReadingShortCmt         (EscapedChar       x) ="]
[CmtOrCodeOrString "    error (",StringBeginOrEnd "\"",CmtOrCodeOrString "while ReadingShortCmt, got EscapedChar: ",StringBeginOrEnd "\"",CmtOrCodeOrString " ++ x)"]
[CmtOrCodeOrString "promote ReadingLongCmt          (EscapedChar       x) ="]
[CmtOrCodeOrString "    error (",StringBeginOrEnd "\"",CmtOrCodeOrString "while ReadingLongCmt, got EscapedChar: ",StringBeginOrEnd "\"",CmtOrCodeOrString " ++ x)"]
[CmtOrCodeOrString "promote ReadingEscCharInStringInCode               x  = StringInCode"]
[CmtOrCodeOrString "                                                          (lltToString x)"]
[CmtOrCodeOrString "promote ReadingEscCharInStringInShortCmt           x  = StringInShortCmt"]
[CmtOrCodeOrString "                                                          (lltToString x)"]
[CmtOrCodeOrString "promote ReadingEscCharInStringInLongCmt            x  = StringInLongCmt"]
[CmtOrCodeOrString "                                                          (lltToString x)"]
[CmtOrCodeOrString "promote _                       (CmtBegin          x) = LongCmt          x"]
[CmtOrCodeOrString "promote _                       (CmtEnd            x) = LongCmt          x"]
[CmtOrCodeOrString "promote ReadingStringInCode     (LineCmtMark       x) = StringInCode     x"]
[CmtOrCodeOrString "promote _                       (LineCmtMark       x) = ShortCmt         x"]
[CmtOrCodeOrString ""]
[CmtOrCodeOrString "startWithList :: [Token] -> String -> Maybe Token"]
[LineCmtMark "--",CmtOrCodeOrString " FBR: use a map/fold here instead of explicit recursion ?"]
[CmtOrCodeOrString "startWithList [] _ = Nothing"]
[CmtOrCodeOrString "startWithList (prfx:others) str"]
[CmtOrCodeOrString "    | isPrefixOf prfx str = Just prfx"]
[CmtOrCodeOrString "    | otherwise           = startWithList others str"]
[CmtOrCodeOrString ""]
[LineCmtMark "--",CmtOrCodeOrString " the remaining string is modified by a token or by a letter consumption"]
[CmtOrCodeOrString "firstMatchedTok :: String"]
[CmtOrCodeOrString "                -> [Token] -> [Token] -> [Token] -> [Token] -> [Token]"]
[CmtOrCodeOrString "                -> Maybe (LowLevelToken, String)"]
[CmtOrCodeOrString "firstMatchedTok [] _ _ _ _ _ = Nothing"]
[CmtOrCodeOrString "firstMatchedTok str@(c:cs) cmtStarters cmtStopers shortCmtStarters"]
[CmtOrCodeOrString "                stringDelims escChars ="]
[CmtOrCodeOrString "    case startWithList escChars str of"]
[CmtOrCodeOrString "      Just matched ->"]
[CmtOrCodeOrString "          Just (EscapedChar matched"]
[CmtOrCodeOrString "               ,consumeTokenUnsafe matched str)"]
[CmtOrCodeOrString "      Nothing ->"]
[CmtOrCodeOrString "          case startWithList stringDelims str of"]
[CmtOrCodeOrString "            Just matched ->"]
[CmtOrCodeOrString "                Just (StringBeginOrEnd matched"]
[CmtOrCodeOrString "                     ,consumeTokenUnsafe matched str)"]
[CmtOrCodeOrString "            Nothing ->"]
[CmtOrCodeOrString "                case startWithList cmtStarters str of"]
[CmtOrCodeOrString "                  Just matched ->"]
[CmtOrCodeOrString "                      Just (CmtBegin matched"]
[CmtOrCodeOrString "                           ,consumeTokenUnsafe matched str)"]
[CmtOrCodeOrString "                  Nothing ->"]
[CmtOrCodeOrString "                      case startWithList cmtStopers str of"]
[CmtOrCodeOrString "                        Just matched ->"]
[CmtOrCodeOrString "                            Just (CmtEnd matched"]
[CmtOrCodeOrString "                                 ,consumeTokenUnsafe matched str)"]
[CmtOrCodeOrString "                        Nothing ->"]
[CmtOrCodeOrString "                            case startWithList shortCmtStarters str of"]
[CmtOrCodeOrString "                              Just matched ->"]
[CmtOrCodeOrString "                                  Just (LineCmtMark matched"]
[CmtOrCodeOrString "                                       ,consumeTokenUnsafe matched str)"]
[CmtOrCodeOrString "                              Nothing -> Just (CmtOrCodeOrString (c:[])"]
[CmtOrCodeOrString "                                              ,cs)"]
[CmtOrCodeOrString "    where"]
[CmtOrCodeOrString "      ",LineCmtMark "--",CmtOrCodeOrString " !!! tok _MUST_ be a prefix of str !!!"]
[CmtOrCodeOrString "      consumeTokenUnsafe :: Token -> String -> String"]
[CmtOrCodeOrString "      consumeTokenUnsafe tok tokPrefixedStr = drop (length tok) tokPrefixedStr"]
[CmtOrCodeOrString ""]
[LineCmtMark "--",CmtOrCodeOrString " line to list of tokens"]
[CmtOrCodeOrString "tokenizeSrcLine :: Bool"]
[CmtOrCodeOrString "                -> [Token] -> [Token] -> [Token] -> [Token] -> [Token]"]
[CmtOrCodeOrString "                -> [LowLevelToken] -> String -> [LowLevelToken]"]
[LineCmtMark "--",CmtOrCodeOrString " empty line in source file"]
[CmtOrCodeOrString "tokenizeSrcLine _ _ _ _ _ _ _ ",StringBeginOrEnd "\"",StringBeginOrEnd "\"",CmtOrCodeOrString " = (CmtOrCodeOrString ",StringBeginOrEnd "\"",StringBeginOrEnd "\"",CmtOrCodeOrString "):[]"]
[LineCmtMark "--",CmtOrCodeOrString " non empty line"]
[CmtOrCodeOrString "tokenizeSrcLine escaping"]
[CmtOrCodeOrString "                cmtStarters cmtStopers shortCmtStarters stringDelims escChars"]
[CmtOrCodeOrString "                acc srcLine ="]
[CmtOrCodeOrString "    case firstMatchedTok srcLine cmtStarters cmtStopers shortCmtStarters"]
[CmtOrCodeOrString "                         stringDelims escChars of"]
[CmtOrCodeOrString "      Nothing -> reverse acc"]
[CmtOrCodeOrString "      Just (tok, []) -> reverse (factorize escaping tok acc)"]
[CmtOrCodeOrString "      Just (tok, remaining@(_:_)) ->"]
[CmtOrCodeOrString "          case tok of"]
[CmtOrCodeOrString "            EscapedChar _ ->"]
[CmtOrCodeOrString "                tokenizeSrcLine (xor True escaping)"]
[CmtOrCodeOrString "                                cmtStarters cmtStopers shortCmtStarters"]
[CmtOrCodeOrString "                                stringDelims escChars"]
[CmtOrCodeOrString "                                (factorize escaping tok acc) remaining"]
[CmtOrCodeOrString "            _ ->"]
[CmtOrCodeOrString "                tokenizeSrcLine False"]
[CmtOrCodeOrString "                                cmtStarters cmtStopers shortCmtStarters"]
[CmtOrCodeOrString "                                stringDelims escChars"]
[CmtOrCodeOrString "                                (factorize escaping tok acc) remaining"]
[CmtOrCodeOrString "    where"]
[CmtOrCodeOrString "      factorize :: Bool -> LowLevelToken -> [LowLevelToken] -> [LowLevelToken]"]
[CmtOrCodeOrString "      factorize _ elt [] = elt:[]"]
[CmtOrCodeOrString "      factorize escaping' elt lst@(x:xs)"]
[CmtOrCodeOrString "          | escaping' ="]
[CmtOrCodeOrString "              case x of"]
[CmtOrCodeOrString "                (EscapedChar z) ->"]
[CmtOrCodeOrString "                    (EscapedChar (z ++ (lltToString elt))):xs"]
[CmtOrCodeOrString "                _ -> error (",StringBeginOrEnd "\"",CmtOrCodeOrString "x is not an EscapedChar while we are escaping: ",StringBeginOrEnd "\""]
[CmtOrCodeOrString "                            ++ (lltToString elt))"]
[CmtOrCodeOrString "          | otherwise ="]
[CmtOrCodeOrString "              case (elt, x) of"]
[CmtOrCodeOrString "                (CmtOrCodeOrString y, CmtOrCodeOrString z) ->"]
[CmtOrCodeOrString "                    (CmtOrCodeOrString (z ++ y)):xs"]
[CmtOrCodeOrString "                (CmtBegin y, CmtBegin z) ->"]
[CmtOrCodeOrString "                    (CmtBegin (z ++ y)):xs"]
[CmtOrCodeOrString "                (CmtEnd y, CmtEnd z) ->"]
[CmtOrCodeOrString "                    (CmtEnd (z ++ y)):xs"]
[CmtOrCodeOrString "                (LineCmtMark y, LineCmtMark z) ->"]
[CmtOrCodeOrString "                    (LineCmtMark (z ++ y)):xs"]
[CmtOrCodeOrString "                ",LineCmtMark "--",CmtOrCodeOrString " consecutive StringBeginOrEnd low level tokens must not be"]
[CmtOrCodeOrString "                ",LineCmtMark "--",CmtOrCodeOrString " factorized together to manage correctly the empty string ",StringBeginOrEnd "\"",StringBeginOrEnd "\""]
[CmtOrCodeOrString "                _ -> elt:lst"]
[CmtOrCodeOrString ""]
[CmtOrCodeOrString "xor :: Bool -> Bool -> Bool"]
[CmtOrCodeOrString "xor True True = False"]
[CmtOrCodeOrString "xor _ _ = True"]
[CmtOrCodeOrString ""]
[LineCmtMark "--",CmtOrCodeOrString " file name to list of lines read"]
[CmtOrCodeOrString "getLines :: String -> IO [String]"]
[CmtOrCodeOrString "getLines fileName ="]
[CmtOrCodeOrString "    do mfh <- try (openFile fileName ReadMode)"]
[CmtOrCodeOrString "       case mfh of"]
[CmtOrCodeOrString "         Left err -> do print err"]
[CmtOrCodeOrString "                        return []"]
[CmtOrCodeOrString "         Right h ->"]
[CmtOrCodeOrString "             do getLines' h []"]
[CmtOrCodeOrString "    where"]
[CmtOrCodeOrString "      getLines' :: Handle -> [String] -> IO [String]"]
[CmtOrCodeOrString "      getLines' h acc ="]
[CmtOrCodeOrString "          do mline <- try (hGetLine h)"]
[CmtOrCodeOrString "             case mline of"]
[CmtOrCodeOrString "               Left _ -> return (reverse acc)"]
[CmtOrCodeOrString "               Right line -> getLines' h (line:acc)"]
[CmtOrCodeOrString ""]
[LineCmtMark "--",CmtOrCodeOrString " file name to list of low level tokens"]
[CmtOrCodeOrString "tokenizeFile :: String -> [Token] -> [Token] -> [Token] -> [Token] -> [Token]"]
[CmtOrCodeOrString "             -> IO [[LowLevelToken]]"]
[CmtOrCodeOrString "tokenizeFile fileName cmtStarters cmtStopers shortCmtStarters stringDelims"]
[CmtOrCodeOrString "             escChars ="]
[CmtOrCodeOrString "    do readLines <- getLines fileName"]
[CmtOrCodeOrString "       return (map (tokenizeSrcLine False"]
[CmtOrCodeOrString "                                    cmtStarters cmtStopers shortCmtStarters"]
[CmtOrCodeOrString "                                    stringDelims escChars [])"]
[CmtOrCodeOrString "                   readLines)"]
[CmtOrCodeOrString ""]
[LineCmtMark "--",CmtOrCodeOrString " low to high level tokens"]
[CmtOrCodeOrString "highLevelTokens :: [[LowLevelToken]] -> ParserState -> Int"]
[CmtOrCodeOrString "                -> [HighLevelToken] -> [[HighLevelToken]]"]
[CmtOrCodeOrString "                -> [[HighLevelToken]]"]
[CmtOrCodeOrString "highLevelTokens [] _ _ _ acc = reverse acc"]
[CmtOrCodeOrString "highLevelTokens (line:others) parserState depth lineAcc acc ="]
[CmtOrCodeOrString "    case line of"]
[CmtOrCodeOrString "      ",LineCmtMark "--",CmtOrCodeOrString " finished current line"]
[CmtOrCodeOrString "      [] -> case parserState of"]
[CmtOrCodeOrString "              ReadingShortCmt ->"]
[CmtOrCodeOrString "                  ",LineCmtMark "--",CmtOrCodeOrString " state only valid until end of current line"]
[CmtOrCodeOrString "                  highLevelTokens others ReadingCode"]
[CmtOrCodeOrString "                                  depth [] ((reverse lineAcc):acc)"]
[CmtOrCodeOrString "              _ ->"]
[CmtOrCodeOrString "                  highLevelTokens others parserState"]
[CmtOrCodeOrString "                                  depth [] ((reverse lineAcc):acc)"]
[CmtOrCodeOrString "      ",LineCmtMark "--",CmtOrCodeOrString " continuing current line"]
[CmtOrCodeOrString "      (tok:toks) ->"]
[CmtOrCodeOrString "          case parserState of"]
[CmtOrCodeOrString "            ReadingCode ->"]
[CmtOrCodeOrString "                case tok of"]
[CmtOrCodeOrString "                  CmtOrCodeOrString _ ->"]
[CmtOrCodeOrString "                      highLevelTokens"]
[CmtOrCodeOrString "                         (toks:others) parserState"]
[CmtOrCodeOrString "                         depth (factorize parserState tok lineAcc) acc"]
[CmtOrCodeOrString "                  LineCmtMark _ ->"]
[CmtOrCodeOrString "                      highLevelTokens"]
[CmtOrCodeOrString "                         (toks:others) ReadingShortCmt"]
[CmtOrCodeOrString "                         depth (factorize ReadingShortCmt tok lineAcc) acc"]
[CmtOrCodeOrString "                  CmtBegin _ ->"]
[CmtOrCodeOrString "                      highLevelTokens"]
[CmtOrCodeOrString "                         (toks:others) ReadingLongCmt"]
[CmtOrCodeOrString "                         (depth+1) (factorize parserState tok lineAcc) acc"]
[CmtOrCodeOrString "                  StringBeginOrEnd _ ->"]
[CmtOrCodeOrString "                      highLevelTokens"]
[CmtOrCodeOrString "                         (toks:others) ReadingStringInCode"]
[CmtOrCodeOrString "                         depth (factorize parserState tok lineAcc) acc"]
[CmtOrCodeOrString "                  CmtEnd mark ->"]
[CmtOrCodeOrString "                      error (",StringBeginOrEnd "\"",CmtOrCodeOrString "got EndCmtMArk while ReadingCode: ",StringBeginOrEnd "\"",CmtOrCodeOrString " ++ mark)"]
[CmtOrCodeOrString "                  EscapedChar esc ->"]
[CmtOrCodeOrString "                      error (",StringBeginOrEnd "\"",CmtOrCodeOrString "got EscapedChar while ReadingCode: ",StringBeginOrEnd "\"",CmtOrCodeOrString " ++ esc)"]
[CmtOrCodeOrString "            ReadingShortCmt ->"]
[CmtOrCodeOrString "                case tok of"]
[CmtOrCodeOrString "                  StringBeginOrEnd _ ->"]
[CmtOrCodeOrString "                      highLevelTokens"]
[CmtOrCodeOrString "                         (toks:others) ReadingStringInShortCmt"]
[CmtOrCodeOrString "                         depth (factorize parserState tok lineAcc) acc"]
[CmtOrCodeOrString "                  EscapedChar esc ->"]
[CmtOrCodeOrString "                      error (",StringBeginOrEnd "\"",CmtOrCodeOrString "got EscapedChar while ReadingShortCmt: ",StringBeginOrEnd "\"",CmtOrCodeOrString " ++ esc)"]
[CmtOrCodeOrString "                  _ ->"]
[CmtOrCodeOrString "                      highLevelTokens"]
[CmtOrCodeOrString "                         (toks:others) parserState"]
[CmtOrCodeOrString "                         depth (factorize parserState tok lineAcc) acc"]
[CmtOrCodeOrString "            ReadingLongCmt ->"]
[CmtOrCodeOrString "                case tok of"]
[CmtOrCodeOrString "                  CmtEnd _ ->"]
[CmtOrCodeOrString "                      let newDepth = depth - 1 in"]
[CmtOrCodeOrString "                      if newDepth == 0 then"]
[CmtOrCodeOrString "                          highLevelTokens"]
[CmtOrCodeOrString "                             (toks:others) ReadingCode"]
[CmtOrCodeOrString "                             newDepth (factorize parserState tok lineAcc) acc"]
[CmtOrCodeOrString "                      else"]
[CmtOrCodeOrString "                          highLevelTokens"]
[CmtOrCodeOrString "                            (toks:others) parserState"]
[CmtOrCodeOrString "                            newDepth (factorize parserState tok lineAcc) acc"]
[CmtOrCodeOrString "                  CmtBegin _ ->"]
[CmtOrCodeOrString "                      let newDepth = depth + 1 in"]
[CmtOrCodeOrString "                      highLevelTokens"]
[CmtOrCodeOrString "                         (toks:others) parserState"]
[CmtOrCodeOrString "                         newDepth (factorize parserState tok lineAcc) acc"]
[CmtOrCodeOrString "                  CmtOrCodeOrString _ ->"]
[CmtOrCodeOrString "                      highLevelTokens"]
[CmtOrCodeOrString "                         (toks:others) parserState"]
[CmtOrCodeOrString "                         depth (factorize parserState tok lineAcc) acc"]
[CmtOrCodeOrString "                  LineCmtMark mark ->"]
[CmtOrCodeOrString "                      error (",StringBeginOrEnd "\"",CmtOrCodeOrString "got LineCmtMark while ReadingLongCmt: ",StringBeginOrEnd "\"",CmtOrCodeOrString " ++ mark)"]
[CmtOrCodeOrString "                  StringBeginOrEnd _ ->"]
[CmtOrCodeOrString "                      highLevelTokens"]
[CmtOrCodeOrString "                         (toks:others) ReadingStringInLongCmt"]
[CmtOrCodeOrString "                         depth (factorize parserState tok lineAcc) acc"]
[CmtOrCodeOrString "                  EscapedChar esc ->"]
[CmtOrCodeOrString "                      error (",StringBeginOrEnd "\"",CmtOrCodeOrString "got EscapedChar while ReadingLongCmt: ",StringBeginOrEnd "\"",CmtOrCodeOrString " ++ esc)"]
[CmtOrCodeOrString "            ReadingStringInLongCmt ->"]
[CmtOrCodeOrString "                case tok of"]
[CmtOrCodeOrString "                  StringBeginOrEnd _ ->"]
[CmtOrCodeOrString "                      highLevelTokens"]
[CmtOrCodeOrString "                         (toks:others) ReadingLongCmt"]
[CmtOrCodeOrString "                         depth (factorize parserState tok lineAcc) acc"]
[CmtOrCodeOrString "                  EscapedChar _ ->"]
[CmtOrCodeOrString "                      highLevelTokens"]
[CmtOrCodeOrString "                         (toks:others) ReadingEscCharInStringInLongCmt"]
[CmtOrCodeOrString "                         depth (factorize parserState tok lineAcc) acc"]
[CmtOrCodeOrString "                  _ ->"]
[CmtOrCodeOrString "                      highLevelTokens"]
[CmtOrCodeOrString "                         (toks:others) parserState"]
[CmtOrCodeOrString "                         depth (factorize parserState tok lineAcc) acc"]
[CmtOrCodeOrString "            ReadingStringInShortCmt ->"]
[CmtOrCodeOrString "                case tok of"]
[CmtOrCodeOrString "                  StringBeginOrEnd _ ->"]
[CmtOrCodeOrString "                      highLevelTokens"]
[CmtOrCodeOrString "                         (toks:others) ReadingShortCmt"]
[CmtOrCodeOrString "                         depth (factorize parserState tok lineAcc) acc"]
[CmtOrCodeOrString "                  EscapedChar _ ->"]
[CmtOrCodeOrString "                      highLevelTokens"]
[CmtOrCodeOrString "                         (toks:others) ReadingEscCharInStringInShortCmt"]
[CmtOrCodeOrString "                         depth (factorize parserState tok lineAcc) acc"]
[CmtOrCodeOrString "                  _ ->"]
[CmtOrCodeOrString "                      highLevelTokens"]
[CmtOrCodeOrString "                         (toks:others) parserState"]
[CmtOrCodeOrString "                         depth (factorize parserState tok lineAcc) acc"]
[CmtOrCodeOrString "            ReadingStringInCode ->"]
[CmtOrCodeOrString "                case tok of"]
[CmtOrCodeOrString "                  StringBeginOrEnd _ ->"]
[CmtOrCodeOrString "                      highLevelTokens"]
[CmtOrCodeOrString "                         (toks:others) ReadingCode"]
[CmtOrCodeOrString "                         depth (factorize parserState tok lineAcc) acc"]
[CmtOrCodeOrString "                  EscapedChar _ ->"]
[CmtOrCodeOrString "                      highLevelTokens"]
[CmtOrCodeOrString "                         (toks:others) ReadingEscCharInStringInCode"]
[CmtOrCodeOrString "                         depth (factorize parserState tok lineAcc) acc"]
[CmtOrCodeOrString "                  _ ->"]
[CmtOrCodeOrString "                      highLevelTokens"]
[CmtOrCodeOrString "                         (toks:others) parserState"]
[CmtOrCodeOrString "                         depth (factorize parserState tok lineAcc) acc"]
[CmtOrCodeOrString "            ReadingEscCharInStringInCode ->"]
[CmtOrCodeOrString "                case tok of"]
[CmtOrCodeOrString "                  StringBeginOrEnd _ ->"]
[CmtOrCodeOrString "                      highLevelTokens"]
[CmtOrCodeOrString "                         (toks:others) ReadingCode"]
[CmtOrCodeOrString "                         depth (factorize parserState tok lineAcc) acc"]
[CmtOrCodeOrString "                  _ ->"]
[CmtOrCodeOrString "                      highLevelTokens"]
[CmtOrCodeOrString "                         (toks:others) ReadingStringInCode"]
[CmtOrCodeOrString "                         depth (factorize parserState tok lineAcc) acc"]
[CmtOrCodeOrString "            ReadingEscCharInStringInShortCmt ->"]
[CmtOrCodeOrString "                case tok of"]
[CmtOrCodeOrString "                  StringBeginOrEnd _ ->"]
[CmtOrCodeOrString "                      highLevelTokens"]
[CmtOrCodeOrString "                         (toks:others) ReadingShortCmt"]
[CmtOrCodeOrString "                         depth (factorize parserState tok lineAcc) acc"]
[CmtOrCodeOrString "                  _ ->"]
[CmtOrCodeOrString "                      highLevelTokens"]
[CmtOrCodeOrString "                         (toks:others) ReadingStringInShortCmt"]
[CmtOrCodeOrString "                         depth (factorize parserState tok lineAcc) acc"]
[CmtOrCodeOrString "            ReadingEscCharInStringInLongCmt ->"]
[CmtOrCodeOrString "                case tok of"]
[CmtOrCodeOrString "                  StringBeginOrEnd _ ->"]
[CmtOrCodeOrString "                      highLevelTokens"]
[CmtOrCodeOrString "                         (toks:others) ReadingLongCmt"]
[CmtOrCodeOrString "                         depth (factorize parserState tok lineAcc) acc"]
[CmtOrCodeOrString "                  _ ->"]
[CmtOrCodeOrString "                      highLevelTokens"]
[CmtOrCodeOrString "                         (toks:others) ReadingStringInLongCmt"]
[CmtOrCodeOrString "                         depth (factorize parserState tok lineAcc) acc"]
[CmtOrCodeOrString "    where"]
[CmtOrCodeOrString "      factorize :: ParserState -> LowLevelToken -> [HighLevelToken]"]
[CmtOrCodeOrString "                -> [HighLevelToken]"]
[CmtOrCodeOrString "      factorize state elt [] = (promote state elt):[]"]
[CmtOrCodeOrString "      factorize state elt lst@(x:xs) ="]
[CmtOrCodeOrString "        let elt' = promote state elt in"]
[CmtOrCodeOrString "        case (x, elt') of"]
[CmtOrCodeOrString "          (Code y, Code z) -> (Code (y ++ z)):xs"]
[CmtOrCodeOrString "          (ShortCmt y, ShortCmt z) -> (ShortCmt (y ++ z)):xs"]
[CmtOrCodeOrString "          (LongCmt y, LongCmt z) -> (LongCmt (y ++ z)):xs"]
[CmtOrCodeOrString "          (StringInCode y, StringInCode z) -> (StringInCode (y ++ z)):xs"]
[CmtOrCodeOrString "          (StringInShortCmt y, StringInShortCmt z) ->"]
[CmtOrCodeOrString "              (StringInShortCmt (y ++ z)):xs"]
[CmtOrCodeOrString "          (StringInLongCmt y, StringInLongCmt z) ->"]
[CmtOrCodeOrString "              (StringInLongCmt (y ++ z)):xs"]
[CmtOrCodeOrString "          _ -> elt':lst"]
[CmtOrCodeOrString ""]
[CmtOrCodeOrString "rmCmtsWrapper :: String -> IO [[HighLevelToken]]"]
[CmtOrCodeOrString "rmCmtsWrapper fileName ="]
[CmtOrCodeOrString "    do lowLevelToks <- tokenizeFile fileName [] [] [",StringBeginOrEnd "\"",LineCmtMark "--",StringBeginOrEnd "\"",CmtOrCodeOrString "] [",StringBeginOrEnd "\"",EscapedChar "\\\"",StringBeginOrEnd "\"",CmtOrCodeOrString "] [",StringBeginOrEnd "\"",EscapedChar "\\\\",StringBeginOrEnd "\"",CmtOrCodeOrString "]"]
[CmtOrCodeOrString "       let highLevelToks = highLevelTokens lowLevelToks ReadingCode 0 [] []"]
[CmtOrCodeOrString "           codeOnly = removeComments highLevelToks"]
[CmtOrCodeOrString "       return codeOnly"]
[CmtOrCodeOrString "    where"]
[CmtOrCodeOrString "      removeComments :: [[HighLevelToken]] -> [[HighLevelToken]]"]
[CmtOrCodeOrString "      removeComments srcLine = map (filter isCode) srcLine"]
[CmtOrCodeOrString ""]
[CmtOrCodeOrString "      isCode :: HighLevelToken -> Bool"]
[CmtOrCodeOrString "      isCode (Code _)         = True"]
[CmtOrCodeOrString "      isCode (StringInCode _) = True"]
[CmtOrCodeOrString "      isCode _                = False"]
[CmtOrCodeOrString ""]
[CmtOrCodeOrString "lowLevelTokenizeWrapper :: String -> IO [[LowLevelToken]]"]
[CmtOrCodeOrString "lowLevelTokenizeWrapper fileName ="]
[CmtOrCodeOrString "    do lowLevelToks <- tokenizeFile fileName [] [] [",StringBeginOrEnd "\"",LineCmtMark "--",StringBeginOrEnd "\"",CmtOrCodeOrString "] [",StringBeginOrEnd "\"",EscapedChar "\\\"",StringBeginOrEnd "\"",CmtOrCodeOrString "] [",StringBeginOrEnd "\"",EscapedChar "\\\\",StringBeginOrEnd "\"",CmtOrCodeOrString "]"]
[CmtOrCodeOrString "       return lowLevelToks"]
[CmtOrCodeOrString ""]
[CmtOrCodeOrString "highLevelTokenizeWrapper :: String -> IO [[HighLevelToken]]"]
[CmtOrCodeOrString "highLevelTokenizeWrapper fileName ="]
[CmtOrCodeOrString "    do lowLevelToks <- tokenizeFile fileName [] [] [",StringBeginOrEnd "\"",LineCmtMark "--",StringBeginOrEnd "\"",CmtOrCodeOrString "] [",StringBeginOrEnd "\"",EscapedChar "\\\"",StringBeginOrEnd "\"",CmtOrCodeOrString "] [",StringBeginOrEnd "\"",EscapedChar "\\\\",StringBeginOrEnd "\"",CmtOrCodeOrString "]"]
[CmtOrCodeOrString "       let highLevelToks = highLevelTokens lowLevelToks ReadingCode 0 [] []"]
[CmtOrCodeOrString "       return highLevelToks"]
